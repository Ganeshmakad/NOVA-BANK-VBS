<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nova Bank | System Logs</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --bg-primary: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        --bg-card: rgba(255, 255, 255, 0.05);
        --border-color: rgba(255, 255, 255, 0.1);
        --text-main: #ffffff;
        --text-sec: rgba(255, 255, 255, 0.7);
        --accent-grad: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
        --input-bg: rgba(0, 0, 0, 0.2);
    }
    body.light-mode {
        --bg-primary: linear-gradient(135deg, #f0f4ff, #e0f2fe, #e0e7ff);
        --bg-card: rgba(255, 255, 255, 0.8);
        --border-color: rgba(255, 255, 255, 0.6);
        --text-main: #0f172a;
        --text-sec: #64748b;
        --input-bg: rgba(255, 255, 255, 0.9);
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; transition:0.3s; }
    body { background: var(--bg-primary); min-height: 100vh; color: var(--text-main); padding: 40px; }

    .container { max-width: 1000px; margin: 0 auto; }

    .header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); backdrop-filter: blur(10px);
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .btn-back { background: none; border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; }
    .btn-back:hover { background: rgba(255,255,255,0.1); }

    .controls { display: flex; gap: 15px; margin-bottom: 20px; }
    .controls input, .controls select {
        padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color);
        color: var(--text-main); border-radius: 10px; outline: none;
    }
    .controls input { flex: 1; }

    .table-box {
        background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px;
        padding: 20px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { color: var(--text-sec); font-size: 13px; text-transform: uppercase; }
    tr:hover { background: rgba(255,255,255,0.02); }

    .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
    .pagination button { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .pagination button.active { background: #0ea5e9; border-color: #0ea5e9; color: white; }

    .theme-btn { position: fixed; bottom: 30px; right: 30px; width: 45px; height: 45px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 100; }
</style>
</head>
<body>

<button class="theme-btn" onclick="toggleTheme()">üåô</button>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-history"></i> System Logs</h1>
        <button class="btn-back" onclick="goBack()">Back</button>
    </div>

    <div class="controls">
        <input id="searchInput" placeholder="Search Logs...">
        <select id="orderSelect" onchange="applyFilters()">
            <option value="desc">Newest First</option>
            <option value="asc">Oldest First</option>
        </select>
    </div>

    <div class="table-box">
        <table>
            <thead>
                <tr><th>#</th><th>Target ID</th><th>Description</th><th>Date</th></tr>
            </thead>
            <tbody id="historyBody">
                <tr><td colspan="4" style="text-align:center; padding:30px; color:var(--text-sec)">Loading...</td></tr>
            </tbody>
        </table>
        <div class="pagination" id="pagination"></div>
    </div>
</div>

<script>
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const btn = document.querySelector('.theme-btn');
        btn.textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-mode');
            document.querySelector('.theme-btn').textContent = '‚òÄÔ∏è';
        }
    });

    const API_URL = "http://localhost:8081";
    let allHistories = [];
    let histories = [];
    let currentPage = 1;
    const rowsPerPage = 8;

    function goBack(){ location.href = "admin-dashboard.html"; }

    async function loadHistory(){
        try{
            const res = await fetch(`${API_URL}/histories`);
            allHistories = await res.json();
            applyFilters();
        }catch{
            historyBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">Unable to connect</td></tr>`;
        }
    }

    function applyFilters(){
        const q = searchInput.value.toLowerCase().trim();
        const order = orderSelect.value;
        histories = allHistories.filter(h =>
            (h.targetId && h.targetId.toLowerCase().includes(q)) ||
            (h.description && h.description.toLowerCase().includes(q))
        );
        histories.sort((a,b)=>{
            return order==="desc" ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date);
        });
        currentPage = 1;
        renderTable();
    }

    function renderTable(){
        if(histories.length === 0){
            historyBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:20px;">No logs found</td></tr>`;
            pagination.innerHTML="";
            return;
        }
        const start = (currentPage-1)*rowsPerPage;
        const pageData = histories.slice(start,start+rowsPerPage);

        historyBody.innerHTML = pageData.map((h,i)=>`
        <tr>
            <td>${start+i+1}</td>
            <td style="color:#0ea5e9; font-family:monospace;">${h.targetId || "-"}</td>
            <td>${escapeHtml(h.description)}</td>
            <td style="color:var(--text-sec); font-size:13px;">${formatDate(h.date)}</td>
        </tr>
    `).join("");
        renderPagination();
    }

    function renderPagination(){
        const pages = Math.ceil(histories.length / rowsPerPage);
        let html="";
        for(let i=1;i<=pages;i++){
            html+=`<button class="${i===currentPage?'active':''}" onclick="gotoPage(${i})">${i}</button>`;
        }
        pagination.innerHTML = html;
    }

    function gotoPage(p){ currentPage = p; renderTable(); }
    function formatDate(d){ return d ? new Date(d).toLocaleString() : ""; }
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ""; }

    searchInput.oninput = applyFilters;
    document.addEventListener("DOMContentLoaded", loadHistory);
</script>
</body>
</html>