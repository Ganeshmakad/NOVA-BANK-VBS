<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nova Admin | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        (function() {
            if (localStorage.getItem('theme') === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-sec: rgba(255, 255, 255, 0.7);
            --accent-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --modal-bg: rgba(20, 20, 30, 0.95);
            --input-bg: rgba(255, 255, 255, 0.1);
            --option-bg: #0f0c29;
        }

        body.light-mode {
            --bg-primary: linear-gradient(135deg, #f0f4ff, #f5f3ff, #fae8ff);
            --bg-card: rgba(255, 255, 255, 0.8);
            --border-color: rgba(102, 126, 234, 0.2);
            --text-main: #1e1b4b;
            --text-sec: #64748b;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --modal-bg: rgba(255, 255, 255, 0.95);
            --input-bg: rgba(255, 255, 255, 0.6);
            --option-bg: #ffffff;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; transition: 0.3s; }
        body { background: var(--bg-primary); min-height: 100vh; color: var(--text-main); display: flex; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar {
            width: 260px; background: var(--bg-card); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color); height: 100vh; position: fixed;
            padding: 30px; display: flex; flex-direction: column; z-index: 100;
        }
        .brand {
            font-size: 22px; font-weight: 900; margin-bottom: 40px;
            display: flex; align-items: center; gap: 10px;
            letter-spacing: -0.5px;
        }
        .brand span { background: var(--accent-grad); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .menu-btn {
            padding: 15px; width: 100%; text-align: left; background: none; border: none;
            color: var(--text-sec); cursor: pointer; border-radius: 12px; font-size: 15px; font-weight: 500;
            display: flex; align-items: center; gap: 15px; margin-bottom: 5px; transition: 0.2s;
        }
        .menu-btn:hover, .menu-btn.active { background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .menu-btn.logout { color: #ef4444; margin-top: auto; }
        .menu-btn.logout:hover { background: rgba(239, 68, 68, 0.1); }

        /* Content */
        .main { margin-left: 260px; padding: 40px; width: 100%; }

        .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .btn-grad {
            background: var(--accent-grad); color: white; border: none; padding: 12px 25px;
            border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .btn-grad:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border-color); padding: 25px; border-radius: 20px;
            backdrop-filter: blur(10px); box-shadow: var(--shadow); transition: transform 0.3s, border-color 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: #667eea; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .stat-card p { font-size: 13px; color: var(--text-sec); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        .stat-card h2 { font-size: 28px; font-weight: 700; }

        /* Table Section */
        .table-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 30px; backdrop-filter: blur(10px); }

        .controls { display: flex; gap: 15px; margin-bottom: 0px; flex-wrap: wrap; }

        input, select {
            background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 12px 15px; border-radius: 10px; outline: none; font-size: 14px;
        }
        input::placeholder { color: var(--text-sec); opacity: 0.7; }
        option { background: var(--option-bg); color: var(--text-main); }

        .search-input { flex: 1; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 18px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-main); font-size: 13px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; border-bottom: 2px solid var(--border-color); }
        tr:hover { background: rgba(255,255,255,0.02); }

        .btn-sm { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 5px; }
        .btn-view { background: rgba(102, 126, 234, 0.15); color: #667eea; }
        .btn-del { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); z-index: 200; }
        .modal-content { background: var(--modal-bg); padding: 40px; border-radius: 24px; width: 450px; border: 1px solid var(--border-color); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-content input, .modal-content select { width: 100%; margin-bottom: 15px; }
        .modal-content h3 { margin-bottom: 25px; text-align: center; font-size: 22px; }

        .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 30px; }
        .pg-btn { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); cursor: pointer; border-radius: 8px; font-weight: 600; }
        .pg-btn.active { background: #667eea; color: white; border-color: #667eea; }

        /* TOAST NOTIFICATION */
        .toast {
            position: fixed; top: 30px; right: 30px;
            background: var(--modal-bg); border: 1px solid var(--border-color);
            padding: 15px 25px; border-radius: 12px;
            display: none; align-items: center; gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 300;
            animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes slideIn { from{ transform: translateX(100%); opacity: 0; } to{ transform: translateX(0); opacity: 1; } }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.success i { color: #10b981; }

        .toast.error { border-left: 4px solid #ef4444; }
        .toast.error i { color: #ef4444; }

        .theme-float { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; font-size: 20px; }

        @media (max-width: 900px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; padding: 20px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-shield-alt"></i> &nbsp;<span>Nova Admin</span></div>
    <button class="menu-btn active" onclick="location.reload()"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button class="menu-btn" onclick="handleMenu('notification')"><i class="fas fa-bell"></i> Notifications</button>
    <button class="menu-btn" onclick="handleMenu('support')"><i class="fas fa-headset"></i> Support</button>
    <button class="menu-btn" onclick="handleMenu('history')"><i class="fas fa-history"></i> History</button>
    <button class="menu-btn logout" onclick="handleMenu('logout')"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>

<button class="theme-float" onclick="toggleTheme()">ðŸŒ™</button>

<div class="main">
    <div class="topbar">
        <h2>Dashboard</h2>
        <button class="btn-grad btn-add">+ Add User</button>
    </div>

    <div class="stats">
        <div class="stat-card"><p>Total Balance</p><h2>â‚¹<span id="totalBalance">0</span></h2></div>
        <div class="stat-card"><p>Avg Balance</p><h2>â‚¹<span id="avgBalance">0</span></h2></div>
        <div class="stat-card"><p>Active Users</p><h2 id="activeUsers">0</h2></div>
        <div class="stat-card"><p>Total Users</p><h2 id="totalUsers">0</h2></div>
    </div>

    <div class="table-box">
        <div class="controls">
            <input id="searchInput" class="search-input" placeholder="Search users...">
            <button class="btn-grad" onclick="searchUsers()">Search</button>

            <select id="sortBy" onchange="loadUsers()">
                <option value="accountNumber">Sort by ID</option>
                <option value="balance">Sort by Balance</option>
                <option value="name">Sort by Name</option>
                <option value="username">Sort by Username</option>
            </select>

            <select id="order" onchange="loadUsers()">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>

        <table>
            <thead>
            <tr><th>Acc No</th><th>Name</th><th>Username</th><th>Email</th><th>Balance</th><th>Actions</th></tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>
</div>

<div id="viewUserModal" class="modal">
    <div class="modal-content">
        <h3>User Details</h3>
        <p><b>Acc:</b> <span id="viewAccountNo"></span></p>
        <p><b>Name:</b> <span id="viewName"></span></p>
        <p><b>User:</b> <span id="viewUsername"></span></p>
        <p><b>Email:</b> <span id="viewEmail"></span></p>
        <p><b>Gender:</b> <span id="viewGender"></span></p>
        <p><b>Bal:</b> <span id="viewBalance"></span></p>
        <button class="btn-grad" id="closeViewModal" style="width:100%; margin-top:20px; background:#444;">Close</button>
    </div>
</div>

<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3 id="addUserTitle">Add New</h3>
        <form id="addUserForm">
            <select id="addRole" required><option value="">Select Role</option><option value="CUSTOMER">Customer</option><option value="ADMIN">Admin</option></select>
            <input id="addName" placeholder="Full Name" required>
            <input id="addUsername" placeholder="Username" required>
            <input id="addEmail" placeholder="Email" required>
            <input id="addPassword" type="password" placeholder="Password" required>
            <div id="genderField"><select id="addGender"><option value="">Gender</option><option value="MALE">Male</option><option value="FEMALE">Female</option></select></div>
            <div id="balanceField"><input id="addBalance" type="number" placeholder="Opening Balance"></div>
            <div style="display:flex; gap:10px;">
                <button type="button" id="addUserCancel" class="btn-grad" style="background:#555; flex:1;">Cancel</button>
                <button type="submit" id="addUserSubmit" class="btn-grad" style="flex:1;">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content" style="text-align:center">
        <h3 style="color:#ef4444">Delete User?</h3>
        <p id="deleteText" style="margin-bottom:20px; color:var(--text-sec)"></p>
        <p id="deleteError" style="color:#ef4444; display:none; margin-bottom:10px; font-size:14px; font-weight:bold;"></p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="cancelDelete" class="btn-grad" style="background:#555;">Cancel</button>
            <button id="confirmDelete" class="btn-grad" style="background:#ef4444;">Delete</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMsg">Operation Successful</span>
</div>

<script>
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const btn = document.querySelector('.theme-float');
        const isLight = document.body.classList.contains('light-mode');
        btn.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light-mode');
            document.querySelector('.theme-float').textContent = 'â˜€ï¸';
        }
    });

    const ADMIN_ACC = localStorage.getItem("adminId");
    const API = "http://localhost:8081";
    let users = [], page = 1, perPage = 10;

    // --- NEW: TOAST FUNCTION ---
    function showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        const txt = document.getElementById('toastMsg');
        const icon = toast.querySelector('i');

        txt.innerText = msg;
        toast.className = 'toast ' + (isError ? 'error' : 'success');
        icon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';

        toast.style.display = 'flex';
        setTimeout(() => { toast.style.display = 'none'; }, 3500);
    }

    (function checkAdminAuth(){
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const role = localStorage.getItem("role");
        if(isLoggedIn !== "true" || role !== "ADMIN"){ window.location.href = "admin-login.html"; }
    })();

    function handleMenu(v){
        if(v==="logout") { localStorage.clear(); location.href = "home.html"; }
        if(v==="history") location.href="history.html";
        if(v==="notification") location.href="admin-send-notification.html";
        if(v==="support") location.href="admin-support.html";
    }

    async function loadUsers(){
        const res = await fetch(`${API}/users?sortBy=${sortBy.value}&order=${order.value}`);
        users = await res.json();
        page = 1;
        render();
    }

    function render(){
        totalUsers.innerText = users.length;
        const total = users.reduce((s,u)=>s+u.balance,0);
        totalBalance.innerText = total.toFixed(2);
        avgBalance.innerText = (users.length?total/users.length:0).toFixed(2);
        activeUsers.innerText = users.filter(u=>u.balance>0).length;

        const start = (page-1)*perPage;
        const slice = users.slice(start,start+perPage);

        userTable.innerHTML = slice.map(u=>`
        <tr>
            <td>${u.accountNumber}</td>
            <td>${u.name}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td>â‚¹${u.balance.toFixed(2)}</td>
            <td class="actions">
                <button class="btn-sm btn-view view-btn" data-id="${u.accountNumber}">View</button>
                <button class="btn-sm btn-del del-btn" data-id="${u.accountNumber}">Delete</button>
            </td>
        </tr>
    `).join("");

        pagination.innerHTML="";
        for(let i=1;i<=Math.ceil(users.length/perPage);i++){
            pagination.innerHTML+=`<button class="pg-btn ${i===page?'active':''}" onclick="page=${i};render()">${i}</button>`;
        }
    }

    async function searchUsers(){
        const q = searchInput.value.trim();
        if(!q){ loadUsers(); return; }
        const res = await fetch(`${API}/users/${q}`);
        users = await res.json();
        page = 1;
        render();
    }

    document.addEventListener("click", e=>{
        const btn = e.target.closest(".view-btn");
        if(!btn) return;
        const accNo = btn.dataset.id;
        const u = users.find(x => x.accountNumber === accNo);
        if(!u) return;
        viewAccountNo.innerText = u.accountNumber;
        viewName.innerText = u.name;
        viewUsername.innerText = u.username;
        viewEmail.innerText = u.email;
        viewGender.innerText = u.gender || "-";
        viewBalance.innerText = "â‚¹" + u.balance.toFixed(2);
        viewUserModal.style.display = "flex";
    });

    closeViewModal.onclick = ()=> viewUserModal.style.display="none";

    let deleteRow = null;
    let deleteAccNo = null;

    document.addEventListener("click", e=>{
        const btn = e.target.closest(".del-btn");
        if(!btn) return;
        deleteRow = btn.closest("tr");
        deleteAccNo = btn.dataset.id;
        deleteText.innerText = `Are you sure you want to delete account "${deleteAccNo}"?`;
        deleteError.style.display = "none";
        deleteModal.style.display = "flex";
    });

    cancelDelete.onclick = ()=>{ deleteModal.style.display = "none"; };

    confirmDelete.onclick = async ()=>{
        try{
            const res = await fetch(`${API}/delete-user/${deleteAccNo}`, {
                method: "DELETE",
                headers: { "X-ADMIN-ACC": ADMIN_ACC }
            });

            // --- NEW: GRACEFUL ERROR HANDLING ---
            const text = await res.text();

            if (!res.ok) {
                // Try to parse Spring Boot JSON error
                try {
                    const json = JSON.parse(text);
                    // If JSON has 'message', use it. Else use 'error'.
                    showToast(json.message || json.error || "Server Error", true);
                } catch(e) {
                    // If simple string text
                    showToast(text || "Operation Failed", true);
                }
                deleteModal.style.display = "none";
                return;
            }

            // SUCCESS
            if(text.includes("Successfully")) {
                showToast("User deleted successfully!");
                users = users.filter(x => x.accountNumber !== deleteAccNo);
                render();
            } else {
                showToast(text, true); // Fallback for business logic error like "Balance not zero"
            }
            deleteModal.style.display = "none";

        } catch(e) {
            showToast("Connection to Server Failed", true);
            deleteModal.style.display = "none";
        }
    };

    // --- NEW: FORM RESET LOGIC ---
    document.querySelector(".btn-add").onclick = ()=>{
        addUserForm.reset(); // <--- RESET FORM ON OPEN
        addUserModal.style.display = "flex";
        addUserTitle.innerText = "Add New";
        // Reset dynamic fields visibility
        genderField.style.display = "none";
        balanceField.style.display = "none";
    };

    addRole.addEventListener("change", ()=>{
        const role = addRole.value;
        if(role === "ADMIN"){
            genderField.style.display = "none"; balanceField.style.display = "none";
            addGender.required = false; addBalance.required = false;
        } else {
            genderField.style.display = "block"; balanceField.style.display = "block";
            addGender.required = true; addBalance.required = true;
        }
    });

    addUserForm.onsubmit = async (e)=>{
        e.preventDefault();
        const role = addRole.value;
        const base = {
            name: addName.value.trim(), username: addUsername.value.trim(),
            email: addEmail.value.trim(), password: addPassword.value.trim()
        };
        let endpoint = role === "ADMIN" ? "/add/admin" : "/add/user";
        if(role === "CUSTOMER") { base.gender = addGender.value; base.balance = Number(addBalance.value || 0); }

        try{
            const res = await fetch(API + endpoint,{
                method:"POST", headers:{ "Content-Type":"application/json", "X-ADMIN-ACC": ADMIN_ACC },
                body: JSON.stringify(base)
            });
            const msg = await res.text();

            if(!res.ok) {
                // Parse JSON Error
                try {
                    const json = JSON.parse(msg);
                    showToast(json.message || "Failed to add user", true);
                } catch(e) { showToast(msg || "Error", true); }
                return;
            }

            if(msg.includes("Successfully")) {
                showToast("Added Successfully");
                addUserModal.style.display = "none";
                loadUsers();
            } else {
                showToast(msg, true);
            }
        }catch{ showToast("Network Error", true); }
    };

    addUserCancel.onclick = ()=>{
        addUserForm.reset(); // Reset on cancel too
        addUserModal.style.display="none";
    };

    loadUsers();
</script>
</body>
</html>