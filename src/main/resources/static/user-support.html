<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nova Bank | Help Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --bg-primary:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
            --bg-card:rgba(255,255,255,.08);
            --border-color:rgba(255,255,255,.15);
            --text-main:#fff;
            --text-sec:rgba(255,255,255,.7);
            --accent-grad:linear-gradient(135deg,#667eea,#764ba2);
            --input-bg:rgba(0,0,0,.25);
            --modal-bg:rgba(20,20,40,.96);
        }

        body.light-mode{
            --bg-primary:linear-gradient(135deg,#f0f4ff,#f5f3ff,#fae8ff);
            --bg-card:#ffffff;
            --border-color:rgba(102,126,234,.25);
            --text-main:#1e1b4b;
            --text-sec:#64748b;
            --input-bg:#ffffff;
            --modal-bg:#ffffff;
        }

        *{
            margin:0;
            padding:0;
            box-sizing:border-box;
            font-family:"Segoe UI",sans-serif
        }

        body{
            background:var(--bg-primary);
            min-height:100vh;
            color:var(--text-main)
        }

        .hero{
            text-align:center;
            padding:45px 20px
        }

        .hero h1{
            font-size:34px;
            margin-bottom:8px
        }

        .hero p{
            color:var(--text-sec)
        }

        .container{
            max-width:820px;
            margin:auto;
            padding:20px
        }

        .card{
            background:var(--bg-card);
            border:1px solid var(--border-color);
            border-radius:18px;
            padding:30px;
            backdrop-filter:blur(15px);
        }

        input,select,textarea{
            width:100%;
            padding:12px;
            border-radius:10px;
            border:1px solid var(--border-color);
            background:var(--input-bg);
            color:var(--text-main);
        }

        select option{
            background:var(--modal-bg);
            color:var(--text-main);
        }

        label{
            font-size:13px;
            color:var(--text-sec);
            margin-bottom:6px;
            display:block
        }

        .btn{
            background:var(--accent-grad);
            color:#fff;
            border:none;
            padding:12px 26px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
        }

        .issue-card{
            background:var(--bg-card);
            border:1px solid var(--border-color);
            border-radius:14px;
            padding:18px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
            cursor:pointer;
        }

        .status{
            padding:6px 14px;
            border-radius:20px;
            font-size:11px;
            font-weight:700;
        }

        .status.OPEN{
            background:#10b981;
            color:#fff;
        }

        .status.CLOSED{
            background:#64748b;
            color:#fff;
        }

        .theme-btn{
            position:fixed;
            bottom:25px;
            right:25px;
            width:44px;
            height:44px;
            border-radius:50%;
            background:var(--bg-card);
            border:1px solid var(--border-color);
            cursor:pointer;
            font-size:20px;
        }

        /* MODAL */
        .modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.55);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:1000;
        }

        .modal-box{
            width:100%;
            max-width:520px;
            background:var(--modal-bg);
            border:1px solid var(--border-color);
            border-radius:18px;
            padding:25px;
        }

        /* CHAT */
        .chat{
            margin-top:15px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        /* COMMON BUBBLE ‚Äì DESIGN 2 */
        .bubble{
            padding:10px 14px;
            max-width:75%;
            font-size:14px;
            line-height:1.45;
            position:relative;
            word-wrap:break-word;
            border-radius:16px;
        }

        /* USER (RIGHT ‚Äì SENT) */
        .user-bubble{
            align-self:flex-end;
            background:#2563eb;
            color:#fff;
            border-radius:16px 16px 6px 16px;
        }

        /* ADMIN (LEFT ‚Äì RECEIVED) */
        .admin-bubble{
            align-self:flex-start;
            background:#16a34a;
            color:#fff;
            border-radius:16px 16px 16px 6px;
        }

        /* WAITING */
        .waiting{
            align-self:flex-start;
            background:#475569;
            color:#fff;
            padding:10px 14px;
            border-radius:12px;
            font-size:13px;
            font-weight:600;
        }
    </style>
</head>

<body>

<button class="theme-btn" onclick="toggleTheme()">üåô</button>

<div class="hero">
    <h1><i class="fas fa-life-ring"></i> Help Center</h1>
    <p>We are here to assist you with any banking issues.</p>
    <a href="home.html" style="color:var(--text-sec)">‚Üê Home</a>
</div>

<div class="container">

    <div class="card">
        <h3>Raise New Ticket</h3>

        <label>Issue Type</label>
        <select id="issueType">
            <option value="" disabled selected>Select issue type</option>
            <option>Transaction Failed</option>
            <option>Login Issue</option>
            <option>Profile Update</option>
            <option>Other</option>
        </select>

        <label>Subject</label>
        <input id="subject">

        <label>Description</label>
        <textarea id="desc"></textarea>

        <br><br>
        <button class="btn" id="submitBtn" onclick="submitTicket()">Submit Ticket</button>
    </div>

    <br>
    <h3>Your Tickets</h3>
    <br>
    <div id="ticketList"></div>

</div>

<!-- MODAL -->
<div class="modal" id="ticketModal">
    <div class="modal-box">
        <h3 id="modalSubject"></h3>
        <p style="color:var(--text-sec);font-size:13px" id="modalMeta"></p>

        <div class="chat">
            <div class="bubble user-bubble" id="userBubble"></div>
            <div class="bubble admin-bubble" id="adminBubble" style="display:none"></div>
            <div class="bubble waiting" id="waitingBubble" style="display:none">
                ‚è≥ Waiting for admin reply...
            </div>
        </div>

        <br>
        <button class="btn" onclick="closeModal()">Close</button>
    </div>
</div>

<div id="toast" style="
position:fixed;
top:20px;
right:20px;
background:rgba(0,0,0,0.8);
color:#fff;
padding:12px 18px;
border-radius:10px;
display:none;
font-size:14px;
z-index:2000;">
</div>

<script>
    const API = "http://localhost:8081";
    const accountNumber = localStorage.getItem("accountNumber");

    if (!accountNumber) {
        location.href = "user-login.html";
    }


    function toggleTheme(){
        document.body.classList.toggle("light-mode");
        const btn = document.querySelector(".theme-btn");
        btn.textContent = document.body.classList.contains("light-mode") ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem(
            "theme",
            document.body.classList.contains("light-mode")?"light":"dark");
    }

    window.onload = () => {
    if (localStorage.getItem("theme") === "light") {
        document.body.classList.add("light-mode");
        document.querySelector(".theme-btn").textContent = "‚òÄÔ∏è";
    } else {
        document.querySelector(".theme-btn").textContent = "üåô";
    }
    loadTickets();
};


    async function submitTicket(){

    if (!issueType.value) {
        showToast("Please select issue type", true);
        return;
    }

    if (!subject.value.trim() || !desc.value.trim()) {
        showToast("Subject and description are required", true);
        return;
    }

    submitBtn.disabled = true;

    try {
        const res = await fetch(`${API}/support/raise`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                accountNumber,
                issueType: issueType.value,
                subject: subject.value,
                description: desc.value
            })
        });

        const msg = await res.text();

        if (!res.ok) {
            showToast(msg || "Failed to raise ticket", true);
            return;
        }

        showToast("Ticket raised successfully");
        subject.value = "";
        desc.value = "";
        issueType.value = "";
        loadTickets();

    } catch {
        showToast("Server error. Please try again.", true);
    }
    finally{
        submitBtn.disabled = false;
    }
}


    async function loadTickets(){
    try {
        const res = await fetch(`${API}/support/list/${accountNumber}`);
        if (!res.ok) throw new Error();
        const data = await res.json();

        ticketList.innerHTML = "";
        data.forEach(t => {
            const d = document.createElement("div");
            d.className = "issue-card";
            d.onclick = () => openModal(t);
            d.innerHTML = `<b>${t.subject}</b>
                           <span class="status ${t.status}">${t.status}</span>`;
            ticketList.appendChild(d);
        });

        if (!data.length) {
            ticketList.innerHTML =
                `<p style="color:var(--text-sec)">No tickets raised yet</p>`;
        }

    } catch {
        ticketList.innerHTML =
            `<p style="color:var(--text-sec)">Unable to load tickets</p>`;
    }
}


    function openModal(t){
        adminBubble.innerText = "";
        userBubble.innerText = "";
        modalMeta.innerText = "";

        modalSubject.innerText=t.subject;
        modalMeta.innerText=t.issueType+" ‚Ä¢ "+new Date(t.date).toLocaleString();
        userBubble.innerText=t.description;

       if(t.adminReply){
            adminBubble.style.display="block";
            adminBubble.innerText=t.adminReply;
            waitingBubble.style.display="none";
       }else{
            adminBubble.style.display="none";
            waitingBubble.style.display="block";
       }
       ticketModal.style.display="flex";
    }

    function showToast(msg, isError = false){
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.background = isError
    ? "linear-gradient(135deg,#ef4444,#dc2626)"
    : "linear-gradient(135deg,#16a34a,#22c55e)";
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", 3000);
}

    function closeModal(){
        ticketModal.style.display="none";
    }
</script>

</body>
</html>
